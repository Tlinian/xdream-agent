# xdream-agent 构建文档

## 1. 环境要求

### 1.1 基本环境要求
- **Java Development Kit (JDK)**：17 或更高版本
- **Node.js**：18 或更高版本
- **npm**：与Node.js兼容的版本 (通常随Node.js安装)
- **Gradle**：8 或更高版本 (后端项目管理)
- **Git**：用于版本控制
- **Docker**：(可选) 用于容器化部署
- **IDE**：推荐使用 IntelliJ IDEA (后端) 和 Visual Studio Code (前端)

### 1.2 系统要求
- **操作系统**：Windows、macOS 或 Linux
- **内存**：至少 8GB RAM (推荐 16GB 或更高)
- **磁盘空间**：至少 20GB 可用空间
- **网络连接**：用于下载依赖和访问外部服务

## 2. 项目结构

xdream-agent 采用微服务架构，分为前端和后端两大部分。后端包含多个独立的服务模块，通过API网关进行统一管理。

```
xdream-agent/
├── backend/                    # 后端服务
│   ├── gateway/               # API网关
│   ├── auth-service/          # 认证授权服务
│   ├── user-service/          # 用户管理服务
│   ├── chat-service/          # 对话管理服务
│   ├── knowledge-service/     # 知识管理服务
│   ├── task-service/          # 任务管理服务
│   ├── subscription-service/  # 订阅管理服务
│   ├── agent-service/         # Agent编排服务
│   ├── llm-service/           # LLM集成服务
│   ├── emotion-service/       # 情感分析服务
│   ├── multimodal-service/    # 多模态感知服务
│   ├── tool-service/          # 工具调用服务
│   ├── common/                # 公共模块
│   ├── common-database/       # 数据库公共模块
│   └── common-security/       # 安全公共模块
├── frontend/                  # 前端应用
│   ├── src/                   # 前端源码
│   ├── public/                # 静态资源
│   └── package.json           # 前端依赖配置
├── docs/                      # 项目文档
├── scripts/                   # 构建脚本
└── docker/                    # Docker配置
```

## 3. 后端构建流程

### 3.1 克隆项目

```bash
# 克隆项目代码库
git clone <repository-url>
cd xdream-agent
```

### 3.2 环境配置

1. **Java环境配置**
   确保已安装JDK 17或更高版本，并正确配置JAVA_HOME环境变量。

2. **Gradle配置**
   项目使用Gradle Wrapper，无需单独安装Gradle。

3. **配置文件**
   后端服务的配置文件位于各服务模块的`src/main/resources/application.yml`中。主要配置项包括：
   - 数据库连接信息
   - 服务端口号
   - 认证配置
   - LLM服务API密钥和模型配置
   
   对于LLM服务，特别需要在`llm-service`模块的配置文件中设置正确的API密钥和模型信息：
   ```yaml
   ai:
     llm:
       chat:
         base-url: https://api.siliconflow.cn/v1
         interface-url: /chat/completions
         api-key: your-api-key-here
         model: deepseek-ai/DeepSeek-V3
         max-tokens: 4096
         timeout: 30000
   ```

### 3.3 构建后端项目

```bash
# 进入后端目录
cd backend

# 构建整个后端项目
./gradlew build

# 跳过测试构建
./gradlew build -x test

# 构建特定服务（例如llm-service）
./gradlew :llm-service:build
```

### 3.4 运行后端服务

#### 3.4.1 使用Gradle直接运行

```bash
# 运行整个后端服务
./gradlew bootRun

# 运行特定服务（例如llm-service）
./gradlew :llm-service:bootRun

# 以调试模式运行特定服务
./gradlew :llm-service:bootRun --debug-jvm
```

#### 3.4.2 单独运行JAR文件

构建完成后，可以直接运行生成的JAR文件：

```bash
# 构建项目
./gradlew build

# 运行特定服务的JAR文件
java -jar llm-service/build/libs/llm-service-0.0.1-SNAPSHOT.jar

# 以调试模式运行JAR文件
java -jar -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 llm-service/build/libs/llm-service-0.0.1-SNAPSHOT.jar
```

### 3.5 运行测试

```bash
# 运行所有测试
./gradlew test

# 运行特定服务的测试
./gradlew :llm-service:test

# 生成测试报告
./gradlew test jacocoTestReport
```

### 3.6 代码质量检查

```bash
# 运行Checkstyle检查代码风格
./gradlew checkstyleMain checkstyleTest

# 运行PMD静态代码分析
./gradlew pmdMain pmdTest

# 运行Spotbugs静态代码分析
./gradlew spotbugsMain spotbugsTest
```

## 4. 前端构建流程

### 4.1 安装依赖

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install
```

### 4.2 开发模式运行

```bash
# 启动开发服务器
npm run dev
```

开发服务器启动后，可以通过浏览器访问 http://localhost:3000 来查看应用。

### 4.3 构建生产版本

```bash
# 构建生产版本
npm run build

# 构建完成后，可以使用以下命令预览生产版本
npm run preview
```

生产版本的构建文件将生成在`frontend/dist`目录中。

### 4.4 代码检查与格式化

```bash
# 运行ESLint检查代码质量
npm run lint

# 自动修复ESLint错误
npm run lint:fix

# 运行Prettier格式化代码
npm run format
```

## 5. 容器化部署

xdream-agent支持使用Docker进行容器化部署，简化环境配置和部署过程。

### 5.1 构建Docker镜像

```bash
# 在项目根目录构建Docker镜像
docker build -t xdream-agent .

# 构建特定服务的Docker镜像
docker build -t xdream-agent-llm-service -f docker/llm-service/Dockerfile .
```

### 5.2 使用Docker Compose

项目提供了Docker Compose配置，方便同时启动多个服务：

```bash
# 使用Docker Compose启动所有服务
docker-compose -f docker/docker-compose.yml up -d

# 停止所有服务
docker-compose -f docker/docker-compose.yml down
```

### 5.3 容器配置

Docker容器的主要配置项包括：
- 环境变量：用于配置服务参数
- 端口映射：将容器端口映射到主机端口
- 数据卷：持久化存储数据
- 网络设置：配置容器间通信

## 6. CI/CD流水线

项目支持CI/CD流水线自动化构建、测试和部署流程。主要步骤包括：

1. **代码提交**：开发者将代码提交到代码仓库
2. **自动构建**：触发CI/CD流水线，自动构建项目
3. **运行测试**：执行单元测试、集成测试等
4. **代码质量检查**：检查代码风格、质量等
5. **构建镜像**：构建Docker镜像
6. **部署应用**：将应用部署到测试环境或生产环境
7. **监控与通知**：监控部署状态，发送通知

## 7. 常见构建问题与解决方案

### 7.1 依赖下载失败

**问题**：Gradle或npm无法下载依赖包。

**解决方案**：
- 检查网络连接是否正常
- 配置代理服务器（如果需要）
- 清除缓存：`./gradlew clean` 或 `npm cache clean --force`
- 更新依赖版本

### 7.2 编译错误

**问题**：代码编译失败。

**解决方案**：
- 检查代码是否有语法错误
- 检查依赖版本是否兼容
- 运行代码质量检查工具查找问题

### 7.3 测试失败

**问题**：单元测试或集成测试失败。

**解决方案**：
- 检查测试代码是否正确
- 检查测试环境配置是否正确
- 查看测试报告了解具体失败原因

### 7.4 内存不足

**问题**：构建过程中出现内存不足错误。

**解决方案**：
- 增加JVM堆内存：`./gradlew build -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"`
- 关闭其他占用内存的程序

### 7.5 LLM服务连接问题

**问题**：无法连接到LLM服务或API调用失败。

**解决方案**：
- 检查API密钥是否正确配置
- 检查网络连接是否正常
- 检查防火墙设置是否阻止连接
- 查看服务日志了解具体错误信息

## 8. 性能优化建议

### 8.1 后端性能优化
- 使用缓存减少数据库访问
- 优化查询语句，使用索引
- 采用异步处理耗时操作
- 使用连接池管理数据库连接
- 实现请求限流和熔断机制

### 8.2 前端性能优化
- 代码分割和懒加载
- 图片优化和懒加载
- 减少HTTP请求数量
- 使用CDN加速静态资源
- 优化组件渲染性能

### 8.3 构建性能优化
- 使用Gradle缓存加速构建
- 并行构建多个模块
- 增量构建避免重复构建
- 配置合理的内存参数

## 9. 总结

xdream-agent项目采用现代化的构建工具和流程，支持多种构建和部署方式。通过遵循本构建文档中的步骤，开发者可以快速搭建开发环境、构建项目、运行测试和部署应用。

在实际开发过程中，建议使用CI/CD流水线自动化构建和部署流程，提高开发效率和代码质量。同时，关注性能优化和常见问题解决方案，可以确保项目的稳定运行和良好的用户体验。