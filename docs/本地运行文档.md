# xdream-agent 本地运行文档

## 1. 本地环境准备

在开始运行xdream-agent之前，请确保您的本地环境满足以下要求：

### 1.1 软件要求
- **Java Development Kit (JDK)**：17 或更高版本
- **Node.js**：18 或更高版本
- **npm**：与Node.js兼容的版本 (通常随Node.js安装)
- **Git**：用于版本控制
- **IDE**：推荐使用 IntelliJ IDEA (后端) 和 Visual Studio Code (前端)

### 1.2 环境变量配置
- **JAVA_HOME**：指向JDK安装目录
- **NODE_HOME**：指向Node.js安装目录
- **PATH**：包含JDK和Node.js的bin目录

### 1.3 克隆项目代码

```bash
# 克隆项目代码库
git clone <repository-url>
cd xdream-agent
```

## 2. 后端服务配置与启动

### 2.1 配置数据库

xdream-agent后端使用多种数据库：
- **关系型数据库**：开发环境使用H2内存数据库，无需额外配置
- **缓存**：使用Redis (可选，默认配置可能使用内存缓存)
- **向量数据库**：用于知识嵌入存储 (可选，默认可能使用模拟实现)
- **图数据库**：用于知识图谱存储 (可选，默认可能使用模拟实现)

对于基本的开发环境，您只需要确保H2数据库可用，这已经在项目的默认配置中设置好了。

### 2.2 配置LLM服务

LLM服务是项目的核心组件，需要正确配置才能调用外部大语言模型API。

1. 打开`backend/llm-service/src/main/resources/application.yml`文件
2. 配置以下参数：
   ```yaml
   ai:
     llm:
       chat:
         base-url: https://api.siliconflow.cn/v1
         interface-url: /chat/completions
         api-key: your-api-key-here  # 替换为您的真实API密钥
         model: deepseek-ai/DeepSeek-V3
         max-tokens: 4096
         timeout: 30000
   ```

   如果您没有SiliconFlow API密钥，可以使用项目的模拟响应功能，无需修改此配置。

### 2.3 启动后端服务

#### 2.3.1 使用Gradle启动所有服务

```bash
# 进入后端目录
cd backend

# 启动所有后端服务
./gradlew bootRun
```

这种方式会启动所有服务，但在开发环境中可能会消耗大量资源。

#### 2.3.2 启动单个服务

在开发过程中，通常只需要启动特定的服务：

```bash
# 启动认证服务
./gradlew :auth-service:bootRun

# 启动LLM服务
./gradlew :llm-service:bootRun

# 启动API网关
./gradlew :gateway:bootRun
```

#### 2.3.3 使用IDE启动服务

使用IntelliJ IDEA启动后端服务：
1. 打开`backend`目录作为项目
2. 在Gradle工具窗口中，展开`llm-service > Tasks > application`
3. 双击`bootRun`启动LLM服务
4. 同样的方式可以启动其他服务

### 2.4 验证后端服务

后端服务启动后，可以通过以下方式验证是否正常运行：

1. **检查服务日志**：查看控制台输出，确保没有错误信息
2. **访问健康检查端点**：http://localhost:8084/actuator/health (以LLM服务为例)
3. **使用测试脚本**：项目根目录提供了测试脚本
   ```bash
   # 测试LLM服务
   cd ..
   python test_llm_service.py
   ```

## 3. 前端服务配置与启动

### 3.1 配置前端环境

1. 进入前端目录：
   ```bash
   cd frontend
   ```
2. 安装依赖：
   ```bash
   npm install
   ```
3. 配置API端点：
   前端应用默认连接到`http://localhost:8080`作为API网关地址。如果您的后端服务运行在不同的地址或端口，请修改`frontend/.env`文件中的配置。

### 3.2 启动前端服务

```bash
# 启动开发服务器
npm run dev
```

开发服务器启动后，可以通过浏览器访问 http://localhost:3000 来查看和使用应用。

### 3.3 使用VS Code调试前端

1. 安装VS Code和必要的扩展（如ESLint、Prettier、React Extension Pack）
2. 打开`frontend`目录作为工作区
3. 启动开发服务器：`npm run dev`
4. 使用VS Code的调试功能附加到运行中的应用

## 4. 服务间通信

在本地开发环境中，各服务之间的通信方式如下：

- **前端 -> API网关**：通过HTTP请求通信
- **API网关 -> 各后端服务**：通过HTTP请求路由
- **后端服务之间**：通过RESTful API直接调用或消息队列通信
- **LLM服务 -> 外部API**：通过HTTP请求调用外部大语言模型API

## 5. 本地开发工作流

### 5.1 前后端分离开发

1. **启动必要的后端服务**：通常需要启动API网关、认证服务和您正在开发的特定服务
2. **启动前端开发服务器**：`npm run dev`
3. **修改代码**：前端代码修改后会自动刷新，后端代码修改后需要重新启动服务
4. **测试**：使用Postman或其他工具测试API，在浏览器中测试前端功能

### 5.2 常用开发命令

#### 后端开发命令
```bash
# 构建项目
./gradlew build

# 运行测试
./gradlew test

# 格式化代码
./gradlew spotlessApply

# 生成API文档
./gradlew generateOpenApiDocs
```

#### 前端开发命令
```bash
# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 代码检查
npm run lint

# 代码格式化
npm run format

# 运行测试
npm run test
```

## 6. 本地测试

### 6.1 后端测试

```bash
# 运行所有测试
./gradlew test

# 运行特定服务的测试
./gradlew :llm-service:test

# 生成测试报告
./gradlew test jacocoTestReport
```

测试报告将生成在各服务模块的`build/reports`目录中。

### 6.2 前端测试

```bash
# 运行前端测试
cd frontend
npm run test

# 生成测试覆盖率报告
npm run test:coverage
```

### 6.3 API测试

项目提供了API测试脚本：

```bash
# 测试聊天API
cd ..
node test_chat_api.js

# 测试LLM服务API
python test_llm_service.py
```

您也可以使用Postman或Insomnia等工具手动测试API端点。

## 7. 常见问题与解决方案

### 7.1 端口冲突

**问题**：服务启动失败，提示端口已被占用。

**解决方案**：
- 修改`application.yml`文件中的`server.port`配置
- 关闭占用相同端口的其他应用程序
- 查找并杀死占用端口的进程

### 7.2 数据库连接问题

**问题**：无法连接到数据库。

**解决方案**：
- 检查数据库服务是否正在运行
- 验证连接配置（URL、用户名、密码）是否正确
- 确保防火墙设置允许数据库连接

### 7.3 LLM服务调用失败

**问题**：LLM服务无法调用外部API或返回错误。

**解决方案**：
- 检查API密钥是否正确配置
- 验证网络连接是否正常
- 查看服务日志了解具体错误信息
- 如果没有API密钥，系统会自动降级到模拟响应

### 7.4 跨域问题

**问题**：前端应用无法调用后端API，出现跨域错误。

**解决方案**：
- 确保API网关已正确配置CORS（跨域资源共享）
- 在开发环境中，可以使用浏览器插件临时解决跨域问题
- 检查前端请求的API地址是否正确

### 7.5 服务启动缓慢

**问题**：后端服务启动时间过长。

**解决方案**：
- 增加JVM内存分配：`./gradlew bootRun -Dorg.gradle.jvmargs="-Xmx4g"`
- 减少同时启动的服务数量
- 检查是否有耗时的初始化操作

## 8. 调试技巧

### 8.1 后端调试

1. **使用IDE调试**：在IntelliJ IDEA中设置断点，然后以调试模式运行服务
2. **日志调试**：使用`log.info()`、`log.debug()`等方法输出调试信息
3. **远程调试**：配置JVM参数，允许远程调试
   ```bash
   ./gradlew bootRun --debug-jvm
   ```

### 8.2 前端调试

1. **浏览器开发者工具**：使用Chrome DevTools或Firefox Developer Tools调试JavaScript代码
2. **React DevTools**：安装浏览器扩展，调试React组件状态和属性
3. **VS Code调试**：使用VS Code的调试功能附加到运行中的前端应用

### 8.3 API调试

1. **使用Postman**：创建请求集合，测试API端点
2. **日志记录**：在API网关中启用请求/响应日志记录
3. **网络监控**：使用Wireshark或其他工具监控网络请求

## 9. 开发环境优化

### 9.1 配置热重载

后端服务支持热重载，可以在不重启服务的情况下应用代码更改：

```bash
# 使用Spring Boot DevTools启用热重载
./gradlew bootRun -Dspring.devtools.restart.enabled=true
```

### 9.2 配置缓存

在开发环境中，可以禁用某些缓存以方便调试：

```yaml
# 在application.yml中添加
spring:
  cache:
    type: none
```

### 9.3 使用Docker Compose

对于复杂的开发环境，可以使用Docker Compose同时启动多个服务和依赖项：

```bash
# 在项目根目录运行
docker-compose -f docker/docker-compose-dev.yml up -d
```

## 10. 总结

通过本本地运行文档，您应该能够在本地环境中成功配置和运行xdream-agent项目。在开发过程中，建议只启动必要的服务以提高性能，并使用提供的测试工具和调试技巧确保代码质量和功能正确性。

如果您遇到任何问题，请参考常见问题与解决方案部分，或查阅项目文档和相关技术文档获取更多帮助。